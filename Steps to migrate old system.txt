--backup old database
exec sp_rename 'Permissions', 'OldPermissions'
exec sp_rename 'Users', 'OldUsers'
exec sp_rename 'UserPermissions', 'OldUserPermissions'
alter table OldUserPermissions drop constraint FK_UserPermissions_Permissions
alter table OldUserPermissions drop constraint FK_UserPermissions_Users
alter table OldUsers drop constraint PK_Users
ALTER TABLE OldUsers DROP PRIMARY KEY
update [OLDUsers] set [Email] = 'claimsrep3x@optimapr.com' where id = 58

--create users into dskautheserver
  INSERT INTO [DsKAuthServer2].[dbo].[Users]
([Email],[Name],[EmailConfirmed],[AccessFailedCount],[LockoutEnd],[LockoutEnabled],[HashedPassword],[Salt],[AccountCreatedDateTime],[LastPasswordChangeDateTime],[PasswordChangeDateTime],[PasswordChangeGuid],[IsEnabled])
	  SELECT [Email], [Name], 1, 0, NULL, 0, '3E8EB9B40829A1B73B1E1E65EAE1F9FE317B27817E0B077E3AA5D14BB383DF3B642AE73C60E79A1F5D256333F319F36813A4BF446F36BAA2E799E9420B8CEAB1',
	  'C6FA6A7C8C20BB61FDED712582DB7F9370263A2C2214651008FDAE3C168A3D0C471BB8D5FD5FD43F7D6255FD6C3BE35BEE21D945B500B992D6AB6CB6031443DE',
	  '2024-04-03 16:33:14.120','2024-04-03 16:33:14.120',NULL, NULL, 1
  FROM [DsKITSM].[dbo].[OldUsers]

--crear role de tech y user en DsK.AuthServer  
    insert into [DsKAuthServer2].[dbo].[ApplicationRoles]
  ([ApplicationId],[RoleName],[RoleDescription],[IsEnabled])
  VALUES (2, 'Tech', 'Tech Rol',1)

  insert into [DsKAuthServer2].[dbo].[ApplicationRoles]
  ([ApplicationId],[RoleName],[RoleDescription],[IsEnabled])
  VALUES (2, 'User', 'User Rol',1)
  
 --insertar en application users
  insert into [DsKAuthServer2].[dbo].[ApplicationUsers]
  ([ApplicationId],[UserId],[LockoutEnd],[LockoutEnabled],[AccessFailedCount],[TwoFactorEnabled],[IsEnabled])
  SELECT 2, id, NULL, 0, 0, 0, 1  
  FROM [DsKAuthServer2].[dbo].[Users]
  where id >= 106


--insertar rol de user a usuarios
  insert into [DsKAuthServer2].[dbo].[UserRoles]
  ([UserId],[RoleId])
  select id, 6 from 
  [DsKAuthServer2].[dbo].[Users]
  where id >= 106
  
 --crear el authentication provider AD en dsk.autheserver
 
 
 --insertar user mappings para users con auth prov de AD
   insert into [DsKAuthServer2].[dbo].[ApplicationAuthenticationProviderUserMappings]
  ([ApplicationAuthenticationProviderId],[ApplicationUserId],[Username],[IsEnabled])
  select 4, c.id, b.Username, 1 from [DsKAuthServer2].[dbo].[Users] a
  LEFT JOIN [DsKITSM].[dbo].[OldUsers] b ON a.Email = b.Email
  LEFT JOIN [DsKAuthServer2].[dbo].[ApplicationUsers] c on a.id = c.UserId and c.ApplicationId = 2
  WHERE a.id >= 106
  order by a.id
 
 
 
 
 -------------------
 

--todo: nueva tabla de logs, mover logging a DsK.AuthServer

alter table RequestAssignedHistory drop constraint FK_RequestAssignedHistory_Requests
alter table RequestMessageHistory drop constraint FK_RequestMessageHistory_Requests
alter table RequestStatusHistory drop constraint FK_RequestStatusHistory_Requests
alter table [Requests] add RequestedByUserId int


--no se puede borrar la tabla de users todavia
UPDATE [Requests]
SET RequestedByUserId = b.Id
FROM  [Requests] a
LEFT JOIN Users b on a.RequestedByUsername = b.Username

remove RequestedByUserId Allow Nulls

ALTER TABLE Requests DROP COLUMN RequestedByUsername;
ALTER TABLE Requests DROP COLUMN RequestedByEmail;
ALTER TABLE Requests DROP COLUMN RequestedByDisplayName;

--
alter table [RequestAssignedHistory] add [AssignedToUserId] int

UPDATE [RequestAssignedHistory]
SET [AssignedToUserId] = b.Id
FROM  [RequestAssignedHistory] a
LEFT JOIN Users b on a.[AssignedTo] = b.Username

ALTER TABLE RequestAssignedHistory DROP COLUMN AssignedTo;


--

alter table [RequestMessageHistory] add UserId int

UPDATE [RequestMessageHistory]
SET UserId = b.Id
FROM  [RequestMessageHistory] a
LEFT JOIN Users b on a.[Username] = b.Username

ALTER TABLE [RequestMessageHistory] DROP COLUMN [Username];
ALTER TABLE [RequestMessageHistory] DROP COLUMN DisplayName;

--

alter table [RequestStatusHistory] add ChangedByUsernameUserId int

UPDATE [RequestStatusHistory]
SET ChangedByUsernameUserId = b.Id
FROM  [RequestStatusHistory] a
LEFT JOIN Users b on a.[ChangedByUsername] = b.Username

ALTER TABLE [RequestStatusHistory] DROP COLUMN [ChangedByUsername];
ALTER TABLE [RequestStatusHistory] DROP COLUMN [ChangedByDisplayName];

--
INSERT INTO [AuthenticationProviders] 
  ([AuthenticationProviderName],[AuthenticationProviderType],[Domain],[Username],[Password])
  VALUES ('AD','Active Directory','domainname','username','password')

INSERT INTO [UserAuthenticationProviders]
  ([UserId],[AuthenticationProviderId],[Username] )
  SELECT [Id],2,[Username]  FROM [Users]
--

crear relaciones entre tablas request

crear relaciones entre request con users (FK_RequestAssignedHistory_Users, FK_RequestMessageHistory_Users)

--
xxx

alter table [Requests] add ITSystemId int

UPDATE [Requests]
SET ITSystemId = b.Id
FROM  [Requests] a
LEFT JOIN ITSystems b on a.System = b.SystemName

ALTER TABLE [Requests] DROP COLUMN [System];

Crear relaciones (FK_Requests_ITSystems)

--

alter table [SOP1Systems] add ITSystemId int

UPDATE [SOP1Systems]
SET ITSystemId = b.Id
FROM  [SOP1Systems] a
LEFT JOIN ITSystems b on a.[System] = b.SystemName

ALTER TABLE [SOP1Systems] DROP COLUMN [System];

crear relacion (FK_SOP1Systems_ITSystems)

--

CREATE TABLE Priority (
	Id int IDENTITY(1,1) PRIMARY KEY,
	PriorityName varchar(10) NOT NULL
);

insert into Priority (PriorityName) VALUES ('Low')
insert into Priority (PriorityName) VALUES ('Medium')
insert into Priority (PriorityName) VALUES ('High')

alter table [Requests] add PriorityId int

UPDATE [Requests]
SET PriorityId = b.Id
FROM  [Requests] a
LEFT JOIN Priority b on a.Priority = b.PriorityName

ALTER TABLE [Requests] DROP COLUMN [Priority];

crear relacion (FK_Requests_Priority)

--


CREATE TABLE Categories (
	Id int IDENTITY(1,1) PRIMARY KEY,
	CategoryName nvarchar(20) NOT NULL
);

insert into Categories (CategoryName) VALUES ('Incident')
insert into Categories (CategoryName) VALUES ('Change Request')
insert into Categories (CategoryName) VALUES ('Service Request')

alter table [Requests] add CategoryId int

UPDATE [Requests]
SET CategoryId = b.Id
FROM  [Requests] a
LEFT JOIN Categories b on a.Category = b.CategoryName

ALTER TABLE [Requests] DROP COLUMN Category;

crear relacion (FK_Requests_Category)
--


CREATE TABLE RequestType (
	Id int IDENTITY(1,1) PRIMARY KEY,
	RequestTypeName nvarchar(20) NOT NULL
);

insert into RequestType (RequestTypeName) VALUES ('Request')
insert into RequestType (RequestTypeName) VALUES ('SOP1')

alter table [Requests] add RequestTypeId int

UPDATE [Requests]
SET RequestTypeId = b.Id
FROM  [Requests] a
LEFT JOIN RequestType b on a.RequestType = b.RequestTypeName

ALTER TABLE [Requests] DROP COLUMN RequestType;

crear relacion (FK_Requests_Category)





DROP TABLE LOG 
DROP TABLE OLDUserPermissions
DROP TABLE OLDPermissions
DROP TABLE OLDUsers